<!doctype html>
<html lang="vi">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDR Candles, Volume & Foreign Flow</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="signal-analysis.js"></script>
  <style>
    body { 
      margin: 0; 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; 
    }
    #app { 
      max-width: 1400px; 
      margin: 16px auto; 
      padding: 8px; 
    }
    #chart { 
      width: 100%; 
      height: 860px; 
      position: relative;
      z-index: 1000;
    }
    .note { 
      color: #555; 
      font-size: 12px; 
      margin-top: 8px; 
    }
    /* Ensure Plotly tooltip can show full content */
    .hoverlayer .hovertext {
      max-width: none !important;
      width: auto !important;
      white-space: normal !important;
      text-align: left !important;
      overflow: visible !important;
      word-wrap: break-word !important;
      background-color: white !important;
    }
    .hoverlayer .hovertext .name {
      white-space: normal !important;
    }
    
    /* Ensure chart has highest z-index */
    .plotly {
      z-index: 1000 !important;
    }
    
    /* Make all Plotly tooltips transparent */
    .hoverlayer .hovertext,
    .hoverlayer .hovertext .name,
    .hoverlayer .hovertext .name .legendtext,
    .plotly .hoverlayer .hovertext {
      background-color: white !important;
      border: 1px solid rgba(0,0,0,0.1) !important;
    }
    
    /* Annotation tooltips */
    .annotation-text-g {
      background-color: white !important;
    }
    
    /* Force transparency on all Plotly elements */
    .plotly .hoverlayer,
    .plotly .hoverlayer *,
    .plotly .annotation,
    .plotly .annotation * {
      background-color: white !important;
    }
  </style>
</head>
<body>
  <div id="app">
    <h3 style="margin:8px 0">PDR — Candlestick & Volume + Foreign Abs(|sell−buy|)</h3>
    <div id="chart"></div>
    <div class="note">Blue: Foreign buy &gt; sell, Orange: sell ≥ buy. Units: Volume (M shares), Foreign Abs (M shares).</div>
  </div>

  <script>
    const JSON_PATH = './pdr_daily_normalized.json';

    fetch(JSON_PATH + '?t=' + Date.now())
      .then(r => r.json())
      .then(rows => {
        // Data preprocessing
        rows = rows.map(r => ({
          time: new Date(r.time),
          open: Number(r.open),
          high: Number(r.high),
          low: Number(r.low),
          close: Number(r.close),
          volume: Number(r.volume),
          foreign_buy_shares: r.foreign_buy_shares != null ? Number(r.foreign_buy_shares) : null,
          foreign_sell_shares: r.foreign_sell_shares != null ? Number(r.foreign_sell_shares) : null,
        }));

        // Format Date object to dd/mm/yyyy
        function formatDate(dateObj) {
          if (!dateObj) return '';
          
          // Handle both Date objects and string dates
          let date;
          if (dateObj instanceof Date) {
            date = dateObj;
          } else if (typeof dateObj === 'string') {
            // If it's a string like "2025-01-02", convert to Date
            date = new Date(dateObj);
          } else {
            return dateObj.toString();
          }
          
          // Check if date is valid
          if (isNaN(date.getTime())) {
            return dateObj.toString();
          }
          
          // Format to dd/mm/yyyy
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          
          return `${day}/${month}/${year}`;
        }

        // Extract arrays - use formatted dates for x-axis like ticktext
        const dt = rows.map(r => formatDate(r.time)); // Use formatted dates for x-axis
        const dtLabels = rows.map(r => formatDate(r.time)); // Keep formatted dates for labels
        
        // Debug: Check dt array
        console.log('dt array length:', dt.length);
        console.log('dt first 5 values:', dt.slice(0, 5));
        console.log('dt last 5 values:', dt.slice(-5));
        console.log('dt[0] type:', typeof dt[0]);
        console.log('dt[0] value:', dt[0]);
        console.log('dtLabels first 5 values:', dtLabels.slice(0, 5));
        console.log('dtLabels last 5 values:', dtLabels.slice(-5));
        console.log('Original time first 5:', rows.slice(0, 5).map(r => r.time));
        console.log('Formatted dtLabels first 5:', dtLabels.slice(0, 5));
        const o = rows.map(r => r.open);
        const h = rows.map(r => r.high);
        const l = rows.map(r => r.low);
        const c = rows.map(r => r.close);
        const vM = rows.map(r => (r.volume || 0) / 1e6);

        // Previous close for comparison
        const prevC = c.map((v, i) => (i > 0 ? c[i-1] : o[0]));

        // --- Technicals: RSI(14) and MACD(12,26,9) computed client-side ---
        function computeEMA(values, period) {
          if (!Array.isArray(values) || values.length === 0) return [];
          const k = 2 / (period + 1);
          const ema = new Array(values.length).fill(null);
          let sum = 0;
          for (let i = 0; i < values.length; i++) {
            const v = values[i];
            if (v == null || Number.isNaN(v)) { ema[i] = null; continue; }
            if (i < period) {
              sum += v;
              if (i === period - 1) ema[i] = sum / period;
              continue;
            }
            const prev = ema[i - 1] == null ? v : ema[i - 1];
            ema[i] = v * k + prev * (1 - k);
          }
          return ema;
        }

        function computeRSI(values, period = 14) {
          const rsi = new Array(values.length).fill(null);
          if (values.length < period + 1) return rsi;
          let gain = 0; let loss = 0;
          for (let i = 1; i <= period; i++) {
            const diff = values[i] - values[i - 1];
            if (diff > 0) gain += diff; else loss -= diff;
          }
          let avgGain = gain / period;
          let avgLoss = loss / period;
          rsi[period] = avgLoss === 0 ? 100 : 100 - (100 / (1 + (avgGain / avgLoss)));
          for (let i = period + 1; i < values.length; i++) {
            const diff = values[i] - values[i - 1];
            const g = diff > 0 ? diff : 0;
            const l = diff < 0 ? -diff : 0;
            avgGain = (avgGain * (period - 1) + g) / period;
            avgLoss = (avgLoss * (period - 1) + l) / period;
            rsi[i] = avgLoss === 0 ? 100 : 100 - (100 / (1 + (avgGain / avgLoss)));
          }
          return rsi;
        }

        function computeMACD(values, fast = 12, slow = 26, signal = 9) {
          const emaFast = computeEMA(values, fast);
          const emaSlow = computeEMA(values, slow);
          const macd = values.map((_, i) => (emaFast[i] != null && emaSlow[i] != null ? emaFast[i] - emaSlow[i] : null));
          const signalLine = computeEMA(macd.map(v => (v == null ? 0 : v)), signal).map((v, i) => (macd[i] == null ? null : v));
          const hist = macd.map((v, i) => (v == null || signalLine[i] == null ? null : v - signalLine[i]));
          return { macd, signal: signalLine, hist };
        }

        const rsi14 = computeRSI(c, 14);
        // Last valid RSI index/value for annotation
        let lastRsiIdx = -1;
        for (let i = rsi14.length - 1; i >= 0; i--) { if (rsi14[i] != null) { lastRsiIdx = i; break; } }
        const lastRsiVal = lastRsiIdx >= 0 ? rsi14[lastRsiIdx] : null;

        const { macd: macd12_26, signal: macdSignal, hist: macdHist } = computeMACD(c, 12, 26, 9);
        
        // Debug MACD calculation
        console.log('MACD calculation debug:');
        console.log('Close prices (first 5):', c.slice(0, 5));
        console.log('MACD values (first 5):', macd12_26.slice(0, 5));
        console.log('MACD Signal (first 5):', macdSignal.slice(0, 5));
        console.log('MACD Hist (first 5):', macdHist.slice(0, 5));
        console.log('MACD Hist non-null count:', macdHist.filter(v => v != null).length);

        // Foreign absolute difference in millions of shares
        const fxAbsB = rows.map(r => {
          const buy = r.foreign_buy_shares || 0;
          const sell = r.foreign_sell_shares || 0;
          return Math.abs(sell - buy) / 1e6;
        });

        const maxFxAbs = fxAbsB.reduce((m, v) => Math.max(m, v || 0), 0);
        const maxVolM = vM.reduce((m, v) => Math.max(m, v || 0), 0);

        // Foreign colors
        const fxColors = rows.map(r => {
          const buy = r.foreign_buy_shares || 0;
          const sell = r.foreign_sell_shares || 0;
          return buy > sell ? 'rgb(30,136,229)' : 'rgb(251,140,0)';
        });

        // Candlestick chart (suppress default hover; use overlay scatter for tooltip)
        const candle = {
          x: dt, 
          open: o, 
          high: h, 
          low: l, 
          close: c,
          type: 'candlestick', 
          name: 'Price', 
          yaxis: 'y', 
          xaxis: 'x',
          hoverinfo: 'skip',
        };

        // Hover-only overlay for candlestick to control tooltip like volume trace
        const candleHover = {
          x: dt,
          y: c,
          type: 'scatter',
          mode: 'markers',
          name: 'price',
          yaxis: 'y',
          xaxis: 'x',
          marker: { size: 6, color: 'rgba(0,0,0,0.001)' },
          hovertemplate: (
            '<span style="text-decoration: underline;">price</span>' +
            '<br>%{text}' +
            '<br>open: %{customdata[0]}' +
            '<br>high: %{customdata[1]}' +
            '<br>low: %{customdata[2]}' +
            '<br>close: %{customdata[3]}' +
            '<extra></extra>'
          ),
          text: rows.map((r, i) => {
            const baseline = Number(prevC[i]);
            const close = Number(r.close);
            const d = (close - baseline);
            const isEqual = Math.abs(d) < 1e-9;
            const color = isEqual ? '#fb8c00' : (d > 0 ? '#16a34a' : '#ef4444');
            const symbol = isEqual ? '■' : (d > 0 ? '▲' : '▼');
            const delta = d.toFixed(2);
            const pct = baseline > 0 ? ((d / baseline) * 100).toFixed(2) : '0.00';
            const sign = d > 0 ? '+' : (d < 0 ? '' : '');
            const box = `<span style="display:inline-block;width:10px;height:10px;background:${color};margin-right:6px;border-radius:2px;vertical-align:middle;"></span>`;
            return `${box}<span style="color:${color}">${symbol} ${sign}${delta} | ${sign}${pct}%</span>`;
          }),
          customdata: rows.map((r) => [r.open, r.high, r.low, r.close]),
          showlegend: false
        };

        // Volume bars with foreign net coloring
        const volColors = rows.map(r => {
          const buy = r.foreign_buy_shares || 0;
          const sell = r.foreign_sell_shares || 0;
          return buy >= sell ? 'rgba(16,185,129,0.8)' : 'rgba(239,68,68,0.8)';
        });

        const vol = {
          x: dt, 
          y: vM, 
          type: 'bar', 
          name: 'Volume (M shrs)',
          marker: { color: volColors }, 
          yaxis: 'y2', 
          xaxis: 'x', 
          opacity: 0.9,
          hovertemplate: (
            '<span style="text-decoration: underline;">volume</span>' +
            '<br>Vol: %{y:.2f} M' +
            '<extra></extra>'
          ),
          customdata: rows.map(r => [
            (r.foreign_buy_shares || 0) - (r.foreign_sell_shares || 0)
          ])
        };

        // Foreign absolute difference overlay
        const fx = {
          x: dt, 
          y: fxAbsB, 
          type: 'bar', 
          name: 'Foreign Abs(|sell−buy|) (M shares)',
          marker: { color: fxColors }, 
          yaxis: 'y2', 
          xaxis: 'x', 
          opacity: 0.5,
          hovertemplate: (
            '<span style="text-decoration: underline;">foreign</span>' +
            '<br>Net: %{customdata[2]:,.0f}' +
            '<br>Buy: %{customdata[0]:,.0f}' +
            '<br>Sell: %{customdata[1]:,.0f}' +
            '<extra></extra>'
          ),
          customdata: rows.map(r => [
            r.foreign_buy_shares || 0,
            r.foreign_sell_shares || 0,
            (r.foreign_buy_shares || 0) - (r.foreign_sell_shares || 0)
          ])
        };

        // Layout configuration
        const layout = {
          dragmode: 'pan',
          legend: { orientation: 'h', x: 0, y: 1.07 },
          margin: { t: 30, r: 50, b: 40, l: 60 },
          xaxis: { 
            domain: [0,1], 
            type: 'category', 
            rangeslider: { visible: false },
            tickangle: -45,
            nticks: 10
          },
          yaxis: { title: 'Price', domain: [0.62, 1.0] },
          yaxis2: { 
            title: 'Volume / Foreign (M shares)', 
            domain: [0.44, 0.60], 
            rangemode: 'tozero', 
            range: [0, Math.max(maxVolM, maxFxAbs) * 1.1] 
          },
          yaxis3: { title: 'RSI(14)', domain: [0.28, 0.42], range: [0, 100] },
          yaxis4: { title: 'MACD(12,26,9)', domain: [0.10, 0.26] },
          barmode: 'overlay',
          hovermode: 'x unified',
          hoverlabel: { align: 'left', namelength: -1 },
          shapes: [
            { 
              type: 'line', 
              xref: 'x', 
              yref: 'y2', 
              x0: dt[0], 
              x1: dt[dt.length-1], 
              y0: 0, 
              y1: 0, 
              line: { color: 'rgba(150,150,150,0.8)', width: 1 } 
            },
            // RSI band 30-70 fill (light purple)
            {
              type: 'rect',
              xref: 'paper',
              yref: 'y3',
              x0: 0,
              x1: 1,
              y0: 30,
              y1: 70,
              line: { width: 0 },
              fillcolor: 'rgba(139,92,246,0.12)'
            }
          ]
        };

        // RSI traces
        const rsiTrace = {
          x: dt,
          y: rsi14,
          type: 'scatter',
          mode: 'lines',
          name: 'RSI(14)',
          line: { color: 'rgb(59,130,246)', width: 1.5 },
          yaxis: 'y3',
          xaxis: 'x',
          hoverinfo: 'skip',
        };

        // Hover-only overlay for RSI to control tooltip
        const rsiHover = {
          x: dt,
          y: rsi14,
          type: 'scatter',
          mode: 'markers',
          name: 'rsi',
          yaxis: 'y3',
          xaxis: 'x',
          marker: { size: 6, color: 'rgba(0,0,0,0.001)' },
          text: rsi14.map(v => {
            if (v == null) return '';
            let color;
            if (v > 70) { color = '#ef4444'; } // red for overbought
            else if (v < 30) { color = '#16a34a'; } // green for oversold
            else { color = '#fb8c00'; } // orange for neutral
            return `<span style="color:${color}">${v.toFixed(2)}</span>`;
          }),
          hovertemplate: '%{text}<extra></extra>',
          showlegend: false
        };
        const rsi70 = { x: dt, y: dt.map(() => 70), type: 'scatter', mode: 'lines', name: 'RSI 70', line: { color: 'rgba(220,38,38,0.6)', width: 1, dash: 'dash' }, yaxis: 'y3', xaxis: 'x', hoverinfo: 'skip', showlegend: false };
        const rsi30 = { x: dt, y: dt.map(() => 30), type: 'scatter', mode: 'lines', name: 'RSI 30', line: { color: 'rgba(16,185,129,0.6)', width: 1, dash: 'dash' }, yaxis: 'y3', xaxis: 'x', hoverinfo: 'skip', showlegend: false };
        const rsi50 = { x: dt, y: dt.map(() => 50), type: 'scatter', mode: 'lines', name: 'RSI 50', line: { color: 'rgb(139,92,246)', width: 1, dash: 'dot' }, yaxis: 'y3', xaxis: 'x', hoverinfo: 'skip', showlegend: false };

        // MACD traces with clear green/red colors like reference chart
        // Filter out null values and create valid histogram data
        const validMacdHist = macdHist.filter(v => v != null);
        const validMacdHistIndices = macdHist.map((v, i) => v != null ? i : null).filter(i => i != null);
        
        console.log('Valid MACD Hist count:', validMacdHist.length);
        console.log('Valid MACD Hist indices:', validMacdHistIndices.slice(0, 10));
        
        const macdHistColors = macdHist.map(v => {
          if (v == null) return 'rgba(128,128,128,0.1)'; // very light gray for null values
          
          const absValue = Math.abs(v);
          
          if (v >= 0) {
            // Positive values - green shades based on intensity
            if (absValue > 0.15) return 'rgba(34,197,94,1.0)'; // Dark green - very strong bullish
            else if (absValue > 0.10) return 'rgba(34,197,94,0.8)'; // Medium green - strong bullish
            else if (absValue > 0.05) return 'rgba(34,197,94,0.6)'; // Light green - moderate bullish
            else return 'rgba(34,197,94,0.4)'; // Very light green - weak bullish
          } else {
            // Negative values - red shades based on intensity
            if (absValue > 0.15) return 'rgba(239,68,68,1.0)'; // Dark red - very strong bearish
            else if (absValue > 0.10) return 'rgba(239,68,68,0.8)'; // Medium red - strong bearish
            else if (absValue > 0.05) return 'rgba(239,68,68,0.6)'; // Light red - moderate bearish
            else return 'rgba(239,68,68,0.4)'; // Very light red - weak bearish
          }
        });

        // Debug MACD colors
        console.log('MACD Hist Colors:', macdHistColors.slice(0, 5));
        console.log('MACD Hist Values:', macdHist.slice(0, 5));
        console.log('MACD Hist Colors length:', macdHistColors.length);
        console.log('MACD Hist Values length:', macdHist.length);

        const macdHistTrace = {
          x: dt,
          y: macdHist,
          type: 'bar',
          name: 'MACD Hist',
          marker: { 
            color: macdHistColors,
            line: { width: 0 }
          },
          yaxis: 'y4',
          xaxis: 'x',
          hovertemplate: (
            '<span style="text-decoration: underline;">macd</span>' +
            '<br>MACD: %{customdata[0]:.3f}' +
            '<br>Signal: %{customdata[1]:.3f}' +
            '<br>Hist: %{y:.3f}' +
            '<extra></extra>'
          ),
          customdata: macdHist.map((v, i) => [
            macd12_26[i] || 0,
            macdSignal[i] || 0
          ])
        };
        
        // Debug MACD trace width
        console.log('MACD Hist Trace width:', macdHistTrace.width);
        console.log('MACD Hist Trace type:', macdHistTrace.type);
        
        const macdLine = { x: dt, y: macd12_26, type: 'scatter', mode: 'lines', name: 'MACD', line: { color: 'rgb(99,102,241)', width: 1.5 }, yaxis: 'y4', xaxis: 'x', hoverinfo: 'skip' };
        const macdSignalLine = { x: dt, y: macdSignal, type: 'scatter', mode: 'lines', name: 'Signal', line: { color: 'rgb(234,179,8)', width: 1.2 }, yaxis: 'y4', xaxis: 'x', hoverinfo: 'skip' };

        // Render chart
        Plotly.newPlot('chart', [candle, candleHover, vol, fx, rsiTrace, rsiHover, rsi70, rsi50, rsi30, macdHistTrace, macdLine, macdSignalLine], layout, {responsive: true, displaylogo: false}).then(() => {
          // Force update MACD histogram colors only
          setTimeout(() => {
            Plotly.restyle('chart', {
              'marker.color': [macdHistColors]
            }, [9]); // Index 9 is macdHistTrace
            console.log('MACD colors updated via restyle');
          }, 100);
          // Add RSI value annotation on the right
          if (lastRsiIdx >= 0 && lastRsiVal != null) {
            const rsiColor = lastRsiVal > 70 ? 'rgba(220,38,38,0.9)' : (lastRsiVal < 30 ? 'rgba(16,185,129,0.9)' : 'rgb(139,92,246)');
            Plotly.relayout('chart', {
              annotations: [
                {
                  x: dt[lastRsiIdx], y: lastRsiVal,
                  xref: 'x', yref: 'y3',
                  text: lastRsiVal.toFixed(2),
                  showarrow: false,
                  xanchor: 'right',
                  align: 'right',
                  bordercolor: rsiColor,
                  borderwidth: 1,
                  bgcolor: 'rgba(255,255,255,0.9)',
                  font: { color: rsiColor, size: 11 }
                }
              ]
            });
          }
        });

        // Click handler: show comprehensive tooltip with all data
        const el = document.getElementById('chart');
        
        // Double-click to clear tooltip
        el.on('plotly_doubleclick', () => {
          Plotly.relayout('chart', { 
            annotations: [],
            shapes: []
          });
          currentTooltipIndex = -1;
          currentTooltipData = null;
          console.log('Tooltip cleared');
        });
        
        // Global variables to track current tooltip state
        let currentTooltipIndex = -1;
        let currentTooltipData = null;
        
        // Keyboard navigation for tooltip
        document.addEventListener('keydown', (event) => {
          if (currentTooltipIndex === -1) return; // No tooltip active
          
          if (event.key === 'ArrowLeft' && currentTooltipIndex > 0) {
            // Navigate to previous day
            currentTooltipIndex--;
            updateTooltip(currentTooltipIndex, currentTooltipData);
          } else if (event.key === 'ArrowRight' && currentTooltipIndex < dt.length - 1) {
            // Navigate to next day
            currentTooltipIndex++;
            updateTooltip(currentTooltipIndex, currentTooltipData);
          } else if (event.key === 'Escape') {
            // Clear tooltip with Escape key
            Plotly.relayout('chart', { 
              annotations: [],
              shapes: []
            });
            currentTooltipIndex = -1;
            currentTooltipData = null;
          }
        });
        
        // Apply transparency to all tooltips after chart is rendered
        setTimeout(() => {
          const style = document.createElement('style');
          style.textContent = `
            .plotly .hoverlayer .hovertext,
            .plotly .hoverlayer .hovertext *,
            .plotly .annotation .annotation-text-g,
            .plotly .annotation .annotation-text-g * {
              background-color: white !important;
              border: 1px solid rgba(0,0,0,0.1) !important;
            }
          `;
          document.head.appendChild(style);
        }, 1000);
        
        // Function to update tooltip with new data
        function updateTooltip(idx, data) {
          try {
            // Price data
            const close = c[idx];
            const prevClose = prevC[idx];
            const d = close - prevClose;
            const up = d >= 0;
            const color = up ? '#16a34a' : '#ef4444';
            const arrow = up ? '▲' : '▼';
            const delta = d.toFixed(2);
            const pct = prevClose ? ((d / prevClose) * 100).toFixed(2) : '0.00';
            const sign = d >= 0 ? '+' : '';
            
            // RSI data
            const rsiVal = rsi14[idx];
            let rsiColor = '#fb8c00';
            if (rsiVal > 70) rsiColor = '#16a34a'; // xanh cho quá mua
            else if (rsiVal < 30) rsiColor = '#ef4444'; // đỏ cho quá bán
            
            // MACD data
            const macdVal = macd12_26[idx] || 0;
            const signalVal = macdSignal[idx] || 0;
            const histVal = macdHist[idx] || 0;
            
            // Foreign data
            const foreignBuy = rows[idx].foreign_buy_shares || 0;
            const foreignSell = rows[idx].foreign_sell_shares || 0;
            const foreignNet = foreignBuy - foreignSell;
            
            // Calculate average volume for signal analysis
            const avgVolume = calculateAverageVolume(vM, idx, 10);
            
            // Analyze signals using external function
            const signalAnalysis = analyzeSignals(d, vM[idx], rsiVal, histVal, foreignNet, avgVolume);
            const warningColor = signalAnalysis.color;
            
            // Create tooltip text with signal analysis
            // Format date as dd/mm/yyyy without time
            const dateStr = dtLabels[idx];
            // Use original time value from JSON
            const formattedDate = dateStr;
            
            const tooltipText = `${formattedDate}<br>${arrow} ${sign}${delta} | ${sign}${pct}%<br>open/close: ${o[idx]} | ${close}<br>vol/f-net: ${(vM[idx] || 0).toFixed(2)} M | ${(foreignNet / 1000000).toFixed(2)} M<br>rsi: ${rsiVal?.toFixed(2) || 'N/A'}<br>macd: ${histVal.toFixed(3)}<br><br>Signal: ${signalAnalysis.signal} (${signalAnalysis.strength}/5)`;
            
            // Show tooltip as Plotly annotation positioned behind vertical line
            Plotly.relayout('chart', {
              annotations: [{
                x: dt[idx], // Use index for x position
                y: close,
                xref: 'x',
                yref: 'y',
                text: tooltipText,
                showarrow: false,
                bgcolor: 'white',
                bordercolor: warningColor,
                borderwidth: 1,
                font: { size: 12, family: 'Arial' },
                align: 'left',
                xanchor: 'left',
                yanchor: 'middle',
                xshift: -200, // Position to the left of the vertical line
                yshift: 0
              }],
              shapes: [{
                type: 'line',
                x0: dt[idx], // Use index for x position
                x1: dt[idx],
                y0: 0,
                y1: 1,
                xref: 'x',
                yref: 'paper',
                line: {
                  color: warningColor,
                  width: 2,
                  dash: 'dash'
                }
              }]
            });
            
            console.log(`Tooltip updated to index: ${idx}`);
          } catch (e) {
            console.error('updateTooltip error:', e);
          }
        }
        
        el.on('plotly_click', (ev) => {
          try {
            console.log('Click event:', ev);
            const pt = ev.points[0];
            const idx = dt.indexOf(pt.x); // Find index of clicked date string
            console.log('Point index:', idx);
            
            // Update global state
            currentTooltipIndex = idx;
            currentTooltipData = { pt, ev };
            
            // Use the updateTooltip function
            updateTooltip(idx, { pt, ev });
            
          } catch (e) {
            console.error('plotly_click handler error:', e);
          }
        });
      })
      .catch(err => {
        document.getElementById('chart').innerHTML = 'Error loading JSON: '+String(err);
      });
  </script>
</body>
</html>