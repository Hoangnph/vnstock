<!doctype html>
<html lang="vi">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDR Candles, Volume & Foreign Flow with Date Filter</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="signal-analysis.js"></script>
  <style>
    body { 
      margin: 0; 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; 
    }
    #app { 
      max-width: 1400px; 
      margin: 16px auto; 
      padding: 8px; 
    }
    #chart { 
      width: 100%; 
      height: 860px; 
      position: relative;
      z-index: 1000;
    }
    .note { 
      color: #555; 
      font-size: 12px; 
      margin-top: 8px; 
    }
    /* Ensure Plotly tooltip can show full content */
    .hoverlayer .hovertext {
      max-width: none !important;
      width: auto !important;
      white-space: normal !important;
      text-align: left !important;
      overflow: visible !important;
      word-wrap: break-word !important;
      background-color: white !important;
    }
    .hoverlayer .hovertext .name {
      white-space: normal !important;
    }
    
    /* Ensure chart has highest z-index */
    .plotly {
      z-index: 1000 !important;
    }
    
    /* Make all Plotly tooltips transparent */
    .hoverlayer .hovertext,
    .hoverlayer .hovertext .name,
    .hoverlayer .hovertext .name .legendtext,
    .plotly .hoverlayer .hovertext {
      background-color: white !important;
      border: 1px solid rgba(0,0,0,0.1) !important;
    }
    
    /* Annotation tooltips */
    .annotation-text-g {
      background-color: white !important;
    }
    
    /* Force transparency on all Plotly elements */
    .plotly .hoverlayer,
    .plotly .hoverlayer *,
    .plotly .annotation,
    .plotly .annotation * {
      background-color: white !important;
    }
  </style>
</head>
<body>
  <div id="app">
    <h3 style="margin:8px 0">PDR ‚Äî Candlestick, MA(6,9,20,50), Volume + Foreign Abs(|sell‚àíbuy|), RSI, MACD, OBV, MFI</h3>
    
    <!-- Date Range Selector -->
    <div style="margin: 16px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
      <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <label for="startDate" style="font-weight: 600; color: #495057;">T·ª´ ng√†y:</label>
          <input type="date" id="startDate" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <label for="endDate" style="font-weight: 600; color: #495057;">ƒê·∫øn ng√†y:</label>
          <input type="date" id="endDate" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
        </div>
        <button id="updateChart" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600;">
          C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
        </button>
        <button id="resetChart" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600;">
          Xem t·∫•t c·∫£
        </button>
      </div>
      <div style="margin-top: 8px; font-size: 12px; color: #6c757d;">
        üí° Ch·ªçn kho·∫£ng th·ªùi gian ƒë·ªÉ xem d·ªØ li·ªáu chi ti·∫øt. D·ªØ li·ªáu c√≥ s·∫µn t·ª´ 2010-07-30 ƒë·∫øn 2025-09-26.
      </div>
    </div>
    
    <div id="chart" style="height: 1000px;"></div>
    <div class="note">MA Colors: MA50(Red), MA20(Blue), MA9(Yellow), MA6(Teal). Blue: Foreign buy &gt; sell, Orange: sell ‚â• buy. Units: Volume (M shares), Foreign Abs (M shares). OBV: On-Balance Volume. MFI: Money Flow Index (20-80 range).</div>
  </div>

  <script>
    const JSON_PATH = './pdr_daily_normalized.json';
    let allData = []; // Store all data
    let currentData = []; // Current filtered data

    // Initialize date inputs with default range (last 2 years)
    function initializeDateInputs() {
      const endDate = new Date();
      const startDate = new Date();
      startDate.setFullYear(endDate.getFullYear() - 2);
      
      document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
      document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
    }

    // Filter data by date range
    function filterDataByDateRange(startDate, endDate) {
      if (!startDate || !endDate) return allData;
      
      const start = new Date(startDate);
      const end = new Date(endDate);
      
      return allData.filter(row => {
        const rowDate = new Date(row.time);
        return rowDate >= start && rowDate <= end;
      });
    }

    // Load initial data
    fetch(JSON_PATH + '?t=' + Date.now())
      .then(r => r.json())
      .then(rows => {
        allData = rows;
        initializeDateInputs();
        
        // Load initial chart with default range (last 2 years)
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const filteredData = filterDataByDateRange(startDate, endDate);
        updateChartWithData(filteredData);
        
        // Setup event listeners
        document.getElementById('updateChart').addEventListener('click', () => {
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;
          
          if (!startDate || !endDate) {
            alert('Vui l√≤ng ch·ªçn c·∫£ ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c');
            return;
          }
          
          const filteredData = filterDataByDateRange(startDate, endDate);
          if (filteredData.length === 0) {
            alert('Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn');
            return;
          }
          
          updateChartWithData(filteredData);
        });
        
        document.getElementById('resetChart').addEventListener('click', () => {
          updateChartWithData(allData);
          // Reset date inputs to show all data
          document.getElementById('startDate').value = '';
          document.getElementById('endDate').value = '';
        });
      })
      .catch(err => {
        document.getElementById('chart').innerHTML = 'Error loading JSON: '+String(err);
      });

    // Update chart with filtered data
    function updateChartWithData(data) {
      if (!data || data.length === 0) {
        console.warn('No data to display');
        return;
      }

      currentData = data;
      console.log(`Updating chart with ${data.length} records`);

        // Data preprocessing
      const rows = data.map(r => ({
          time: new Date(r.time),
          open: Number(r.open),
          high: Number(r.high),
          low: Number(r.low),
          close: Number(r.close),
          volume: Number(r.volume),
          foreign_buy_shares: r.foreign_buy_shares != null ? Number(r.foreign_buy_shares) : null,
          foreign_sell_shares: r.foreign_sell_shares != null ? Number(r.foreign_sell_shares) : null,
        }));

        // Format Date object to dd/mm/yyyy
        function formatDate(dateObj) {
          if (!dateObj) return '';
          
          let date;
          if (dateObj instanceof Date) {
            date = dateObj;
          } else if (typeof dateObj === 'string') {
            date = new Date(dateObj);
          } else {
            return dateObj.toString();
          }
          
          if (isNaN(date.getTime())) {
            return dateObj.toString();
          }
          
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          
          return `${day}/${month}/${year}`;
        }

      // Extract arrays
      const dt = rows.map(r => formatDate(r.time));
      const dtLabels = rows.map(r => formatDate(r.time));
        const o = rows.map(r => r.open);
        const h = rows.map(r => r.high);
        const l = rows.map(r => r.low);
        const c = rows.map(r => r.close);
        const vM = rows.map(r => (r.volume || 0) / 1e6);

        // Previous close for comparison
        const prevC = c.map((v, i) => (i > 0 ? c[i-1] : o[0]));

      // Technical indicators functions
        function computeEMA(values, period) {
          if (!Array.isArray(values) || values.length === 0) return [];
          const k = 2 / (period + 1);
          const ema = new Array(values.length).fill(null);
          let sum = 0;
          for (let i = 0; i < values.length; i++) {
            const v = values[i];
            if (v == null || Number.isNaN(v)) { ema[i] = null; continue; }
            if (i < period) {
              sum += v;
              if (i === period - 1) ema[i] = sum / period;
              continue;
            }
            const prev = ema[i - 1] == null ? v : ema[i - 1];
            ema[i] = v * k + prev * (1 - k);
          }
          return ema;
        }

      function computeSMA(values, period) {
        if (!Array.isArray(values) || values.length === 0) return [];
        const sma = new Array(values.length).fill(null);
        
        for (let i = period - 1; i < values.length; i++) {
          let sum = 0;
          let count = 0;
          
          for (let j = i - period + 1; j <= i; j++) {
            const v = values[j];
            if (v != null && !Number.isNaN(v)) {
              sum += v;
              count++;
            }
          }
          
          if (count === period) {
            sma[i] = sum / period;
          }
        }
        
        return sma;
      }

        function computeRSI(values, period = 14) {
          const rsi = new Array(values.length).fill(null);
          if (values.length < period + 1) return rsi;
          let gain = 0; let loss = 0;
          for (let i = 1; i <= period; i++) {
            const diff = values[i] - values[i - 1];
            if (diff > 0) gain += diff; else loss -= diff;
          }
          let avgGain = gain / period;
          let avgLoss = loss / period;
          rsi[period] = avgLoss === 0 ? 100 : 100 - (100 / (1 + (avgGain / avgLoss)));
          for (let i = period + 1; i < values.length; i++) {
            const diff = values[i] - values[i - 1];
            const g = diff > 0 ? diff : 0;
            const l = diff < 0 ? -diff : 0;
            avgGain = (avgGain * (period - 1) + g) / period;
            avgLoss = (avgLoss * (period - 1) + l) / period;
            rsi[i] = avgLoss === 0 ? 100 : 100 - (100 / (1 + (avgGain / avgLoss)));
          }
          return rsi;
        }

        function computeMACD(values, fast = 12, slow = 26, signal = 9) {
          const emaFast = computeEMA(values, fast);
          const emaSlow = computeEMA(values, slow);
          const macd = values.map((_, i) => (emaFast[i] != null && emaSlow[i] != null ? emaFast[i] - emaSlow[i] : null));
          const signalLine = computeEMA(macd.map(v => (v == null ? 0 : v)), signal).map((v, i) => (macd[i] == null ? null : v));
          const hist = macd.map((v, i) => (v == null || signalLine[i] == null ? null : v - signalLine[i]));
          return { macd, signal: signalLine, hist };
        }

       function computeOBV(close, volume) {
         const obv = new Array(close.length).fill(null);
         if (close.length === 0) return obv;
         
         obv[0] = volume[0] || 0;
         
         for (let i = 1; i < close.length; i++) {
           const prevClose = close[i - 1];
           const currClose = close[i];
           const currVolume = volume[i] || 0;
           
           if (prevClose == null || currClose == null) {
             obv[i] = obv[i - 1];
             continue;
           }
           
           if (currClose > prevClose) {
             obv[i] = obv[i - 1] + currVolume;
           } else if (currClose < prevClose) {
             obv[i] = obv[i - 1] - currVolume;
           } else {
             obv[i] = obv[i - 1];
           }
         }
         
         return obv;
       }

       function computeMFI(high, low, close, volume, period = 14) {
         const mfi = new Array(close.length).fill(null);
         if (close.length < period + 1) return mfi;
         
         // Calculate typical price
         const typicalPrice = close.map((c, i) => {
           const h = high[i] || 0;
           const l = low[i] || 0;
           return (h + l + c) / 3;
         });
         
         // Calculate raw money flow
         const rawMoneyFlow = typicalPrice.map((tp, i) => tp * (volume[i] || 0));
         
         // Calculate positive and negative money flow
         for (let i = period; i < close.length; i++) {
           let positiveFlow = 0;
           let negativeFlow = 0;
           
           for (let j = i - period + 1; j <= i; j++) {
             if (typicalPrice[j] > typicalPrice[j - 1]) {
               positiveFlow += rawMoneyFlow[j];
             } else if (typicalPrice[j] < typicalPrice[j - 1]) {
               negativeFlow += rawMoneyFlow[j];
             }
           }
           
           if (negativeFlow === 0) {
             mfi[i] = 100;
           } else {
             const moneyRatio = positiveFlow / negativeFlow;
             mfi[i] = 100 - (100 / (1 + moneyRatio));
           }
         }
         
         return mfi;
       }

       // Calculate indicators
        const rsi14 = computeRSI(c, 14);
       const { macd: macd12_26, signal: macdSignal, hist: macdHist } = computeMACD(c, 12, 26, 9);
       const ma50 = computeSMA(c, 50);
       const ma20 = computeSMA(c, 20);
       const ma9 = computeSMA(c, 9);
       const ma6 = computeSMA(c, 6);
       
       // Calculate OBV and MFI
       const obv = computeOBV(c, rows.map(r => r.volume));
       const mfi14 = computeMFI(h, l, c, rows.map(r => r.volume), 14);

        // Last valid RSI index/value for annotation
        let lastRsiIdx = -1;
        for (let i = rsi14.length - 1; i >= 0; i--) { if (rsi14[i] != null) { lastRsiIdx = i; break; } }
        const lastRsiVal = lastRsiIdx >= 0 ? rsi14[lastRsiIdx] : null;

      // Foreign data
        const fxAbsB = rows.map(r => {
          const buy = r.foreign_buy_shares || 0;
          const sell = r.foreign_sell_shares || 0;
          return Math.abs(sell - buy) / 1e6;
        });

        const maxFxAbs = fxAbsB.reduce((m, v) => Math.max(m, v || 0), 0);
        const maxVolM = vM.reduce((m, v) => Math.max(m, v || 0), 0);

        const fxColors = rows.map(r => {
          const buy = r.foreign_buy_shares || 0;
          const sell = r.foreign_sell_shares || 0;
          return buy > sell ? 'rgb(30,136,229)' : 'rgb(251,140,0)';
        });

      // Create traces
        const candle = {
          x: dt, 
          open: o, 
          high: h, 
          low: l, 
          close: c,
          type: 'candlestick', 
          name: 'Price', 
          yaxis: 'y', 
          xaxis: 'x',
          hoverinfo: 'skip',
        };

        const candleHover = {
          x: dt,
          y: c,
          type: 'scatter',
          mode: 'markers',
          name: 'price',
          yaxis: 'y',
          xaxis: 'x',
          marker: { size: 6, color: 'rgba(0,0,0,0.001)' },
          hovertemplate: (
            '<span style="text-decoration: underline;">price</span>' +
            '<br>%{text}' +
            '<br>open: %{customdata[0]}' +
            '<br>high: %{customdata[1]}' +
            '<br>low: %{customdata[2]}' +
            '<br>close: %{customdata[3]}' +
            '<extra></extra>'
          ),
          text: rows.map((r, i) => {
            const baseline = Number(prevC[i]);
            const close = Number(r.close);
            const d = (close - baseline);
            const isEqual = Math.abs(d) < 1e-9;
            const color = isEqual ? '#fb8c00' : (d > 0 ? '#16a34a' : '#ef4444');
            const symbol = isEqual ? '‚ñ†' : (d > 0 ? '‚ñ≤' : '‚ñº');
            const delta = d.toFixed(2);
            const pct = baseline > 0 ? ((d / baseline) * 100).toFixed(2) : '0.00';
            const sign = d > 0 ? '+' : (d < 0 ? '' : '');
            const box = `<span style="display:inline-block;width:10px;height:10px;background:${color};margin-right:6px;border-radius:2px;vertical-align:middle;"></span>`;
            return `${box}<span style="color:${color}">${symbol} ${sign}${delta} | ${sign}${pct}%</span>`;
          }),
          customdata: rows.map((r) => [r.open, r.high, r.low, r.close]),
          showlegend: false
        };

      // Moving Average traces
      const ma50Trace = { 
        x: dt, 
        y: ma50, 
        type: 'scatter', 
        mode: 'lines', 
        name: 'MA50', 
        line: { color: 'rgb(255,99,132)', width: 1.5 }, 
        yaxis: 'y', 
        xaxis: 'x', 
        hoverinfo: 'skip' 
      };
      const ma20Trace = { 
        x: dt, 
        y: ma20, 
        type: 'scatter', 
        mode: 'lines', 
        name: 'MA20', 
        line: { color: 'rgb(54,162,235)', width: 1.5 }, 
        yaxis: 'y', 
        xaxis: 'x', 
        hoverinfo: 'skip' 
      };
      const ma9Trace = { 
        x: dt, 
        y: ma9, 
        type: 'scatter', 
        mode: 'lines', 
        name: 'MA9', 
        line: { color: 'rgb(255,205,86)', width: 1.5 }, 
        yaxis: 'y', 
        xaxis: 'x', 
        hoverinfo: 'skip' 
      };
      const ma6Trace = { 
        x: dt, 
        y: ma6, 
        type: 'scatter', 
        mode: 'lines', 
        name: 'MA6', 
        line: { color: 'rgb(75,192,192)', width: 1.5 }, 
        yaxis: 'y', 
        xaxis: 'x', 
        hoverinfo: 'skip' 
      };

      // Volume bars
        const volColors = rows.map(r => {
          const buy = r.foreign_buy_shares || 0;
          const sell = r.foreign_sell_shares || 0;
          return buy >= sell ? 'rgba(16,185,129,0.8)' : 'rgba(239,68,68,0.8)';
        });

        const vol = {
          x: dt, 
          y: vM, 
          type: 'bar', 
          name: 'Volume (M shrs)',
          marker: { color: volColors }, 
          yaxis: 'y2', 
          xaxis: 'x', 
          opacity: 0.9,
          hovertemplate: (
            '<span style="text-decoration: underline;">volume</span>' +
            '<br>Vol: %{y:.2f} M' +
            '<extra></extra>'
          ),
          customdata: rows.map(r => [
            (r.foreign_buy_shares || 0) - (r.foreign_sell_shares || 0)
          ])
        };

        // Foreign absolute difference overlay
        const fx = {
          x: dt, 
          y: fxAbsB, 
          type: 'bar', 
          name: 'Foreign Abs(|sell‚àíbuy|) (M shares)',
          marker: { color: fxColors }, 
          yaxis: 'y2', 
          xaxis: 'x', 
          opacity: 0.5,
          hovertemplate: (
            '<span style="text-decoration: underline;">foreign</span>' +
            '<br>Net: %{customdata[2]:,.0f}' +
            '<br>Buy: %{customdata[0]:,.0f}' +
            '<br>Sell: %{customdata[1]:,.0f}' +
            '<extra></extra>'
          ),
          customdata: rows.map(r => [
            r.foreign_buy_shares || 0,
            r.foreign_sell_shares || 0,
            (r.foreign_buy_shares || 0) - (r.foreign_sell_shares || 0)
          ])
        };

        // RSI traces
        const rsiTrace = {
          x: dt,
          y: rsi14,
          type: 'scatter',
          mode: 'lines',
          name: 'RSI(14)',
          line: { color: 'rgb(59,130,246)', width: 1.5 },
          yaxis: 'y3',
          xaxis: 'x',
          hoverinfo: 'skip',
        };

        const rsiHover = {
          x: dt,
          y: rsi14,
          type: 'scatter',
          mode: 'markers',
          name: 'rsi',
          yaxis: 'y3',
          xaxis: 'x',
          marker: { size: 6, color: 'rgba(0,0,0,0.001)' },
          text: rsi14.map(v => {
            if (v == null) return '';
            let color;
          if (v > 70) { color = '#ef4444'; }
          else if (v < 30) { color = '#16a34a'; }
          else { color = '#fb8c00'; }
            return `<span style="color:${color}">${v.toFixed(2)}</span>`;
          }),
          hovertemplate: '%{text}<extra></extra>',
          showlegend: false
        };
        const rsi70 = { x: dt, y: dt.map(() => 70), type: 'scatter', mode: 'lines', name: 'RSI 70', line: { color: 'rgba(220,38,38,0.6)', width: 1, dash: 'dash' }, yaxis: 'y3', xaxis: 'x', hoverinfo: 'skip', showlegend: false };
        const rsi30 = { x: dt, y: dt.map(() => 30), type: 'scatter', mode: 'lines', name: 'RSI 30', line: { color: 'rgba(16,185,129,0.6)', width: 1, dash: 'dash' }, yaxis: 'y3', xaxis: 'x', hoverinfo: 'skip', showlegend: false };
        const rsi50 = { x: dt, y: dt.map(() => 50), type: 'scatter', mode: 'lines', name: 'RSI 50', line: { color: 'rgb(139,92,246)', width: 1, dash: 'dot' }, yaxis: 'y3', xaxis: 'x', hoverinfo: 'skip', showlegend: false };

      // MACD traces
      const macdHistColors = macdHist.map(v => {
        if (v == null) return 'rgba(128,128,128,0.1)';
        
        const absValue = Math.abs(v);
          
          if (v >= 0) {
          if (absValue > 0.15) return 'rgba(34,197,94,1.0)';
          else if (absValue > 0.10) return 'rgba(34,197,94,0.8)';
          else if (absValue > 0.05) return 'rgba(34,197,94,0.6)';
          else return 'rgba(34,197,94,0.4)';
          } else {
          if (absValue > 0.15) return 'rgba(239,68,68,1.0)';
          else if (absValue > 0.10) return 'rgba(239,68,68,0.8)';
          else if (absValue > 0.05) return 'rgba(239,68,68,0.6)';
          else return 'rgba(239,68,68,0.4)';
        }
      });

        const macdHistTrace = {
          x: dt,
          y: macdHist,
          type: 'bar',
          name: 'MACD Hist',
          marker: { 
            color: macdHistColors,
            line: { width: 0 }
          },
          yaxis: 'y4',
          xaxis: 'x',
          hovertemplate: (
            '<span style="text-decoration: underline;">macd</span>' +
            '<br>MACD: %{customdata[0]:.3f}' +
            '<br>Signal: %{customdata[1]:.3f}' +
            '<br>Hist: %{y:.3f}' +
            '<extra></extra>'
          ),
          customdata: macdHist.map((v, i) => [
            macd12_26[i] || 0,
            macdSignal[i] || 0
          ])
        };
        
        const macdLine = { x: dt, y: macd12_26, type: 'scatter', mode: 'lines', name: 'MACD', line: { color: 'rgb(99,102,241)', width: 1.5 }, yaxis: 'y4', xaxis: 'x', hoverinfo: 'skip' };
        const macdSignalLine = { x: dt, y: macdSignal, type: 'scatter', mode: 'lines', name: 'Signal', line: { color: 'rgb(234,179,8)', width: 1.2 }, yaxis: 'y4', xaxis: 'x', hoverinfo: 'skip' };

       // OBV traces
       const obvTrace = {
         x: dt,
         y: obv,
         type: 'scatter',
         mode: 'lines',
         name: 'OBV',
         line: { color: 'rgb(168,85,247)', width: 1.5 },
         yaxis: 'y5',
         xaxis: 'x',
         hoverinfo: 'skip',
       };

       // MFI traces
       const mfiTrace = {
         x: dt,
         y: mfi14,
         type: 'scatter',
         mode: 'lines',
         name: 'MFI(14)',
         line: { color: 'rgb(236,72,153)', width: 1.5 },
         yaxis: 'y6',
         xaxis: 'x',
         hoverinfo: 'skip',
       };

       const mfiHover = {
         x: dt,
         y: mfi14,
         type: 'scatter',
         mode: 'markers',
         name: 'mfi',
         yaxis: 'y6',
         xaxis: 'x',
         marker: { size: 6, color: 'rgba(0,0,0,0.001)' },
         text: mfi14.map(v => {
           if (v == null) return '';
           let color;
           if (v > 80) { color = '#ef4444'; } // red for overbought
           else if (v < 20) { color = '#16a34a'; } // green for oversold
           else { color = '#fb8c00'; } // orange for neutral
           return `<span style="color:${color}">${v.toFixed(2)}</span>`;
         }),
         hovertemplate: '%{text}<extra></extra>',
         showlegend: false
       };
       
       const mfi80 = { x: dt, y: dt.map(() => 80), type: 'scatter', mode: 'lines', name: 'MFI 80', line: { color: 'rgba(220,38,38,0.6)', width: 1, dash: 'dash' }, yaxis: 'y6', xaxis: 'x', hoverinfo: 'skip', showlegend: false };
       const mfi20 = { x: dt, y: dt.map(() => 20), type: 'scatter', mode: 'lines', name: 'MFI 20', line: { color: 'rgba(16,185,129,0.6)', width: 1, dash: 'dash' }, yaxis: 'y6', xaxis: 'x', hoverinfo: 'skip', showlegend: false };
       const mfi50 = { x: dt, y: dt.map(() => 50), type: 'scatter', mode: 'lines', name: 'MFI 50', line: { color: 'rgb(139,92,246)', width: 1, dash: 'dot' }, yaxis: 'y6', xaxis: 'x', hoverinfo: 'skip', showlegend: false };

      // Layout configuration
      const layout = {
        dragmode: 'pan',
        legend: { orientation: 'h', x: 0, y: 1.07 },
        margin: { t: 30, r: 50, b: 40, l: 60 },
        xaxis: { 
          domain: [0,1], 
          type: 'category', 
          rangeslider: { visible: false },
          tickangle: -45,
          nticks: 10
        },
         yaxis: { title: 'Price', domain: [0.70, 1.0] },
         yaxis2: { 
           title: 'Volume / Foreign (M shares)', 
           domain: [0.58, 0.68], 
           rangemode: 'tozero', 
           range: [0, Math.max(maxVolM, maxFxAbs) * 1.1] 
         },
         yaxis3: { title: 'RSI(14)', domain: [0.48, 0.56], range: [0, 100] },
         yaxis4: { title: 'MACD(12,26,9)', domain: [0.38, 0.46] },
         yaxis5: { title: 'OBV', domain: [0.28, 0.36] },
         yaxis6: { title: 'MFI(14)', domain: [0.18, 0.26], range: [0, 100] },
        barmode: 'overlay',
        hovermode: 'x unified',
        hoverlabel: { align: 'left', namelength: -1 },
        shapes: [
          { 
            type: 'line', 
            xref: 'x', 
            yref: 'y2', 
            x0: dt[0], 
            x1: dt[dt.length-1], 
            y0: 0, 
            y1: 0, 
            line: { color: 'rgba(150,150,150,0.8)', width: 1 } 
          },
           {
             type: 'rect',
             xref: 'paper',
             yref: 'y3',
             x0: 0,
             x1: 1,
             y0: 30,
             y1: 70,
             line: { width: 0 },
             fillcolor: 'rgba(139,92,246,0.12)'
           },
           {
             type: 'rect',
             xref: 'paper',
             yref: 'y6',
             x0: 0,
             x1: 1,
             y0: 20,
             y1: 80,
             line: { width: 0 },
             fillcolor: 'rgba(236,72,153,0.12)'
           }
        ]
      };

       // Render chart
       Plotly.newPlot('chart', [
         candle, candleHover, ma50Trace, ma20Trace, ma9Trace, ma6Trace, 
         vol, fx, rsiTrace, rsiHover, rsi70, rsi50, rsi30, 
         macdHistTrace, macdLine, macdSignalLine,
         obvTrace, mfiTrace, mfiHover, mfi80, mfi20, mfi50
       ], layout, {responsive: true, displaylogo: false}).then(() => {
        // Force update MACD histogram colors
          setTimeout(() => {
            Plotly.restyle('chart', {
              'marker.color': [macdHistColors]
          }, [13]); // Index 13 is macdHistTrace
          }, 100);
        
          // Add RSI value annotation on the right
          if (lastRsiIdx >= 0 && lastRsiVal != null) {
            const rsiColor = lastRsiVal > 70 ? 'rgba(220,38,38,0.9)' : (lastRsiVal < 30 ? 'rgba(16,185,129,0.9)' : 'rgb(139,92,246)');
            Plotly.relayout('chart', {
              annotations: [
                {
                  x: dt[lastRsiIdx], y: lastRsiVal,
                  xref: 'x', yref: 'y3',
                  text: lastRsiVal.toFixed(2),
                  showarrow: false,
                  xanchor: 'right',
                  align: 'right',
                  bordercolor: rsiColor,
                  borderwidth: 1,
                  bgcolor: 'rgba(255,255,255,0.9)',
                  font: { color: rsiColor, size: 11 }
                }
              ]
            });
          }
        });

       // Setup click handlers
       setupClickHandlers(rows, dt, dtLabels, c, prevC, o, vM, rsi14, macd12_26, macdSignal, macdHist, ma50, ma20, ma9, ma6, obv, mfi14);
    }

    // Setup click handlers for tooltip
    function setupClickHandlers(rows, dt, dtLabels, c, prevC, o, vM, rsi14, macd12_26, macdSignal, macdHist, ma50, ma20, ma9, ma6, obv, mfi14) {
        const el = document.getElementById('chart');
        
        // Double-click to clear tooltip
        el.on('plotly_doubleclick', () => {
          Plotly.relayout('chart', { 
            annotations: [],
            shapes: []
          });
          currentTooltipIndex = -1;
          currentTooltipData = null;
        });
        
        // Global variables to track current tooltip state
        let currentTooltipIndex = -1;
        let currentTooltipData = null;
        
        // Keyboard navigation for tooltip
        document.addEventListener('keydown', (event) => {
        if (currentTooltipIndex === -1) return;
          
         if (event.key === 'ArrowLeft' && currentTooltipIndex > 0) {
           currentTooltipIndex--;
           updateTooltip(currentTooltipIndex, currentTooltipData, rows, dt, dtLabels, c, prevC, o, vM, rsi14, macd12_26, macdSignal, macdHist, ma50, ma20, ma9, ma6, obv, mfi14);
         } else if (event.key === 'ArrowRight' && currentTooltipIndex < dt.length - 1) {
           currentTooltipIndex++;
           updateTooltip(currentTooltipIndex, currentTooltipData, rows, dt, dtLabels, c, prevC, o, vM, rsi14, macd12_26, macdSignal, macdHist, ma50, ma20, ma9, ma6, obv, mfi14);
          } else if (event.key === 'Escape') {
            Plotly.relayout('chart', { 
              annotations: [],
              shapes: []
            });
            currentTooltipIndex = -1;
            currentTooltipData = null;
          }
        });
        
       // Function to update tooltip with new data
       function updateTooltip(idx, data, rows, dt, dtLabels, c, prevC, o, vM, rsi14, macd12_26, macdSignal, macdHist, ma50, ma20, ma9, ma6, obv, mfi14) {
          try {
            // Price data
            const close = c[idx];
            const prevClose = prevC[idx];
            const d = close - prevClose;
            const up = d >= 0;
            const color = up ? '#16a34a' : '#ef4444';
            const arrow = up ? '‚ñ≤' : '‚ñº';
            const delta = d.toFixed(2);
            const pct = prevClose ? ((d / prevClose) * 100).toFixed(2) : '0.00';
            const sign = d >= 0 ? '+' : '';
            
            // RSI data
            const rsiVal = rsi14[idx];
            let rsiColor = '#fb8c00';
          if (rsiVal > 70) rsiColor = '#16a34a';
          else if (rsiVal < 30) rsiColor = '#ef4444';
            
            // MACD data
            const macdVal = macd12_26[idx] || 0;
            const signalVal = macdSignal[idx] || 0;
            const histVal = macdHist[idx] || 0;
            
            // Foreign data
            const foreignBuy = rows[idx].foreign_buy_shares || 0;
            const foreignSell = rows[idx].foreign_sell_shares || 0;
            const foreignNet = foreignBuy - foreignSell;
            
            // Calculate average volume for signal analysis
            const avgVolume = calculateAverageVolume(vM, idx, 10);
            
            // Analyze signals using external function
            const signalAnalysis = analyzeSignals(d, vM[idx], rsiVal, histVal, foreignNet, avgVolume);
            const warningColor = signalAnalysis.color;
            
           // MA values
           const ma50Val = ma50[idx]?.toFixed(2) || 'N/A';
           const ma20Val = ma20[idx]?.toFixed(2) || 'N/A';
           const ma9Val = ma9[idx]?.toFixed(2) || 'N/A';
           const ma6Val = ma6[idx]?.toFixed(2) || 'N/A';
           
           // OBV and MFI values
           const obvVal = obv[idx]?.toFixed(0) || 'N/A';
           const mfiVal = mfi14[idx]?.toFixed(2) || 'N/A';
           
           // Create tooltip text
           const dateStr = dtLabels[idx];
           const formattedDate = dateStr;
           
           const tooltipText = `${formattedDate}<br>${arrow} ${sign}${delta} | ${sign}${pct}%<br>open/close: ${o[idx]} | ${close}<br>vol/f-net: ${(vM[idx] || 0).toFixed(2)} M | ${(foreignNet / 1000000).toFixed(2)} M<br>MA6: ${ma6Val} | MA9: ${ma9Val} | MA20: ${ma20Val} | MA50: ${ma50Val}<br>rsi: ${rsiVal?.toFixed(2) || 'N/A'} | mfi: ${mfiVal}<br>macd: ${histVal.toFixed(3)} | obv: ${obvVal}<br><br>Signal: ${signalAnalysis.signal} (${signalAnalysis.strength}/5)`;
            
          // Show tooltip as Plotly annotation
            Plotly.relayout('chart', {
              annotations: [{
              x: dt[idx],
                y: close,
                xref: 'x',
                yref: 'y',
                text: tooltipText,
                showarrow: false,
                bgcolor: 'white',
                bordercolor: warningColor,
                borderwidth: 1,
                font: { size: 12, family: 'Arial' },
                align: 'left',
                xanchor: 'left',
                yanchor: 'middle',
              xshift: -200,
                yshift: 0
              }],
              shapes: [{
                type: 'line',
              x0: dt[idx],
                x1: dt[idx],
                y0: 0,
                y1: 1,
                xref: 'x',
                yref: 'paper',
                line: {
                  color: warningColor,
                  width: 2,
                  dash: 'dash'
                }
              }]
            });
            
          } catch (e) {
            console.error('updateTooltip error:', e);
          }
        }
        
        el.on('plotly_click', (ev) => {
          try {
            const pt = ev.points[0];
          const idx = dt.indexOf(pt.x);
            
           currentTooltipIndex = idx;
           currentTooltipData = { pt, ev };
           
           updateTooltip(idx, { pt, ev }, rows, dt, dtLabels, c, prevC, o, vM, rsi14, macd12_26, macdSignal, macdHist, ma50, ma20, ma9, ma6, obv, mfi14);
            
          } catch (e) {
            console.error('plotly_click handler error:', e);
          }
        });
    }

    // Apply transparency to all tooltips after chart is rendered
    setTimeout(() => {
      const style = document.createElement('style');
      style.textContent = `
        .plotly .hoverlayer .hovertext,
        .plotly .hoverlayer .hovertext *,
        .plotly .annotation .annotation-text-g,
        .plotly .annotation .annotation-text-g * {
          background-color: white !important;
          border: 1px solid rgba(0,0,0,0.1) !important;
        }
      `;
      document.head.appendChild(style);
    }, 1000);
  </script>
</body>
</html>
