<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDR Candles, Volume & Foreign Flow</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body { 
      margin: 0; 
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; 
    }
    #app { 
      max-width: 1400px; 
      margin: 16px auto; 
      padding: 8px; 
    }
    #chart { 
      width: 100%; 
      height: 860px; 
    }
    .note { 
      color: #555; 
      font-size: 12px; 
      margin-top: 8px; 
    }
    /* Ensure Plotly tooltip can show full content */
    .hoverlayer .hovertext {
      max-width: none !important;
      width: auto !important;
      white-space: normal !important;
      text-align: left !important;
      overflow: visible !important;
      word-wrap: break-word !important;
    }
    .hoverlayer .hovertext .name {
      white-space: normal !important;
    }
  </style>
</head>
<body>
  <div id="app">
    <h3 style="margin:8px 0">PDR — Candlestick & Volume + Foreign Abs(|sell−buy|)</h3>
    <div id="chart"></div>
    <div class="note">Blue: Foreign buy &gt; sell, Orange: sell ≥ buy. Units: Volume (M shares), Foreign Abs (M shares).</div>
  </div>

  <script>
    const JSON_PATH = './pdr_daily_normalized.json';

    fetch(JSON_PATH + '?t=' + Date.now())
      .then(r => r.json())
      .then(rows => {
        // Data preprocessing
        rows = rows.map(r => ({
          time: new Date(r.time),
          open: Number(r.open),
          high: Number(r.high),
          low: Number(r.low),
          close: Number(r.close),
          volume: Number(r.volume),
          foreign_buy_shares: r.foreign_buy_shares != null ? Number(r.foreign_buy_shares) : null,
          foreign_sell_shares: r.foreign_sell_shares != null ? Number(r.foreign_sell_shares) : null,
        }));

        // Extract arrays
        const dt = rows.map(r => r.time);
        const o = rows.map(r => r.open);
        const h = rows.map(r => r.high);
        const l = rows.map(r => r.low);
        const c = rows.map(r => r.close);
        const vM = rows.map(r => (r.volume || 0) / 1e6);

        // Previous close for comparison
        const prevC = c.map((v, i) => (i > 0 ? c[i-1] : o[0]));

        // Foreign absolute difference in millions of shares
        const fxAbsB = rows.map(r => {
          const buy = r.foreign_buy_shares || 0;
          const sell = r.foreign_sell_shares || 0;
          return Math.abs(sell - buy) / 1e6;
        });

        const maxFxAbs = fxAbsB.reduce((m, v) => Math.max(m, v || 0), 0);
        const maxVolM = vM.reduce((m, v) => Math.max(m, v || 0), 0);

        // Foreign colors
        const fxColors = rows.map(r => {
          const buy = r.foreign_buy_shares || 0;
          const sell = r.foreign_sell_shares || 0;
          return buy > sell ? 'rgb(30,136,229)' : 'rgb(251,140,0)';
        });

        // Candlestick chart with colored arrows
        const candle = {
          x: dt, 
          open: o, 
          high: h, 
          low: l, 
          close: c,
          type: 'candlestick', 
          name: 'Price', 
          yaxis: 'y', 
          xaxis: 'x',
          customdata: rows.map((r, i) => {
            const baseline = Number(prevC[i]);
            const close = Number(r.close);
            const up = close >= baseline;
            const color = up ? '#16a34a' : '#ef4444';
            const arrow = up ? '▲' : '▼';
            const d = (close - baseline);
            const delta = d.toFixed(2);
            const pct = baseline > 0 ? ((d / baseline) * 100).toFixed(2) : '0.00';
            const sign = d >= 0 ? '+' : '';
            return [
              `<span style="color:${color}">C: ${close.toFixed(2)}</span>`,
              `<span style="color:${color}">${arrow} ${sign}${delta} | ${sign}${pct}%</span>`
            ];
          }),
          hovertemplate: '%{x|%d-%m-%Y}<br>O:%{open}<br>H:%{high}<br>L:%{low}<br>%{customdata[0]}<br>%{customdata[1]}<extra>Price</extra>'
        };

        // Volume bars with foreign net coloring
        const volColors = rows.map(r => {
          const buy = r.foreign_buy_shares || 0;
          const sell = r.foreign_sell_shares || 0;
          return buy >= sell ? 'rgba(16,185,129,0.8)' : 'rgba(239,68,68,0.8)';
        });

        const vol = {
          x: dt, 
          y: vM, 
          type: 'bar', 
          name: 'Volume (M shrs)',
          marker: { color: volColors }, 
          yaxis: 'y2', 
          xaxis: 'x', 
          opacity: 0.9,
          hovertemplate: (
            '%{x|%d-%m-%Y}' +
            '<br>Vol: %{y:.2f} M' +
            '<br>Foreign net: %{customdata[0]:,.0f} shares' +
            '<extra>Volume</extra>'
          ),
          customdata: rows.map(r => [
            (r.foreign_buy_shares || 0) - (r.foreign_sell_shares || 0)
          ])
        };

        // Foreign absolute difference overlay
        const fx = {
          x: dt, 
          y: fxAbsB, 
          type: 'bar', 
          name: 'Foreign Abs(|sell−buy|) (M shares)',
          marker: { color: fxColors }, 
          yaxis: 'y2', 
          xaxis: 'x', 
          opacity: 0.5,
          hovertemplate: (
            '%{x|%d-%m-%Y}' +
            '<br>Buy: %{customdata[0]:,.0f} shares' +
            '<br>Sell: %{customdata[1]:,.0f} shares' +
            '<br>Vol: %{customdata[2]:.2f} M' +
            '<br>Abs(|sell−buy|): %{y:.2f} M' +
            '<extra>Foreign</extra>'
          ),
          customdata: rows.map(r => [
            r.foreign_buy_shares || 0,
            r.foreign_sell_shares || 0,
            (r.volume || 0)/1e6
          ])
        };

        // Layout configuration
        const layout = {
          dragmode: 'pan',
          legend: { orientation: 'h', x: 0, y: 1.07 },
          margin: { t: 30, r: 50, b: 40, l: 60 },
          xaxis: { domain: [0,1], type: 'date', rangeslider: { visible: false } },
          yaxis: { title: 'Price', domain: [0.45, 1.0] },
          yaxis2: { 
            title: 'Volume / Foreign (M shares)', 
            domain: [0.18, 0.42], 
            rangemode: 'tozero', 
            range: [0, Math.max(maxVolM, maxFxAbs) * 1.1] 
          },
          barmode: 'overlay',
          hovermode: 'x unified',
          hoverlabel: { align: 'left', namelength: -1 },
          shapes: [
            { 
              type: 'line', 
              xref: 'x', 
              yref: 'y2', 
              x0: dt[0], 
              x1: dt[dt.length-1], 
              y0: 0, 
              y1: 0, 
              line: { color: 'rgba(150,150,150,0.8)', width: 1 } 
            }
          ]
        };

        // Render chart
        Plotly.newPlot('chart', [candle, vol, fx], layout, {responsive: true, displaylogo: false});

        // Debug: log candlestick info on click
        const el = document.getElementById('chart');
        el.on('plotly_click', (ev) => {
          try {
            const pt = ev.points.find(p => p.data.type === 'candlestick') || ev.points[0];
            const idx = pt.pointNumber;
            const info = {
              date: dt[idx]?.toISOString().slice(0,10),
              open: o[idx],
              high: h[idx],
              low: l[idx],
              close: c[idx],
              prev_close: prevC[idx],
              delta: (c[idx] - prevC[idx]).toFixed(2),
              pct: prevC[idx] ? (((c[idx]-prevC[idx])/prevC[idx])*100).toFixed(2)+'%' : null
            };
            // Recreate the tooltip HTML exactly like customdata[0]
            const up = (c[idx] - prevC[idx]) >= 0;
            const color = up ? '#16a34a' : '#ef4444';
            const arrow = up ? '▲' : '▼';
            const d = (c[idx] - prevC[idx]);
            const delta = d.toFixed(2);
            const pct = prevC[idx] ? ((d / prevC[idx]) * 100).toFixed(2) : '0.00';
            const sign = d >= 0 ? '+' : '';
            const tooltipHtml = `<span style="color:${color}">C: ${c[idx].toFixed(2)} ${arrow} (${sign}${delta} | ${sign}${pct}%)</span>`;
            console.log('[candlestick click]', info);
            console.log('[tooltip html]', tooltipHtml);
            // Debug full tooltip content
            const fullTooltip = `${dt[idx]?.toLocaleDateString('vi-VN')}<br>O:${o[idx]}<br>H:${h[idx]}<br>L:${l[idx]}<br>${tooltipHtml}`;
            console.log('[full tooltip content]', fullTooltip);
            console.log('[customdata[0] from trace]', pt.data.customdata[idx]);
          } catch (e) {
            console.error('plotly_click handler error:', e);
          }
        });
      })
      .catch(err => {
        document.getElementById('chart').innerHTML = 'Error loading JSON: '+String(err);
      });
  </script>
</body>
</html>